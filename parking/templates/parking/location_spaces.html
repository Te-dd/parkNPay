{% extends 'parking/base.html' %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-dark-puce mb-4 sm:mb-0">{{ location.name }}</h1>
        <a href="{% url 'dashboard' %}" class="bg-spanish-gray text-white px-4 py-2 rounded hover:bg-opacity-80 transition duration-200 text-center sm:text-left">
            Back to Dashboard
        </a>
    </div>

    <!-- Selected Space Info - Moved to top level -->
    <div id="selectedSpaceInfo" class="hidden mb-6 sm:mb-8 p-4 sm:p-6 bg-sea/10 rounded-lg shadow-md transform transition-all duration-300">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h3 class="text-xl sm:text-2xl font-semibold text-dark-puce mb-2">Selected Parking Space</h3>
                <p class="text-spanish-gray text-base sm:text-lg" id="spaceDetails"></p>
            </div>
            <div class="text-left sm:text-right">
                <p class="text-spanish-gray text-sm mb-1">Status</p>
                <span class="bg-sea text-dark-puce px-3 py-1 rounded-full text-sm font-medium">Available</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8">
        <!-- Parking Space Grid -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-dark-puce">Available Spaces</h2>
            
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 sm:gap-4">
                {% for space in available_spaces %}
                    <div class="text-center">
                        {% if space.is_available %}
                            <button onclick="selectSpace('{{ space.id }}', '{{ space.space_number }}', '{{ space.side }}')" class="w-full group" data-space-id="{{ space.id }}">
                                <div class="w-full aspect-square rounded-lg flex items-center justify-center mb-2 bg-sea text-dark-puce font-medium cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-lg group-hover:bg-sea/80 space-block text-sm sm:text-base">
                                    {{ space.space_number }}
                                </div>
                                <p class="text-spanish-gray text-xs sm:text-sm group-hover:text-dark-puce transition-colors duration-300">Side {{ space.side }}</p>
                            </button>
                        {% else %}
                            <div class="w-full">
                                <div class="w-full aspect-square rounded-lg flex items-center justify-center mb-2 bg-coral text-dark-puce font-medium cursor-not-allowed opacity-75 text-sm sm:text-base">
                                    {{ space.space_number }}
                                </div>
                                <p class="text-spanish-gray text-xs sm:text-sm">Side {{ space.side }}</p>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Booking Form -->
        {% if form %}
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-dark-puce">Book a Space</h2>
            
            <!-- Pricing Information -->
            <div class="mb-6 p-4 bg-oatmeal rounded-lg">
                <h3 class="font-semibold text-dark-puce mb-2">Pricing:</h3>
                <ul class="text-spanish-gray space-y-1 text-sm sm:text-base">
                    <li>• KES 30 per hour (for same-day bookings)</li>
                    <li>• KES 200 per day (for multi-day bookings)</li>
                    <li class="text-xs sm:text-sm mt-2">* Minimum booking duration: 1 hour</li>
                </ul>
            </div>

            <form method="post" class="space-y-4" id="bookingForm">
                {% csrf_token %}
                {% for field in form %}
                    <div>
                        <label class="block text-spanish-gray mb-2 text-sm sm:text-base">{{ field.label }}</label>
                        {{ field.errors }}
                        {{ field }}
                    </div>
                {% endfor %}
                <button type="submit" class="w-full bg-dark-puce text-white py-3 px-4 rounded hover:bg-opacity-80 transition duration-200 text-sm sm:text-base">
                    Book Now
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-8 mb-8">
        <div class="flex items-center">
            <div class="w-5 h-5 sm:w-6 sm:h-6 rounded bg-sea mr-2"></div>
            <span class="text-spanish-gray text-sm sm:text-base">Available</span>
        </div>
        <div class="flex items-center">
            <div class="w-5 h-5 sm:w-6 sm:h-6 rounded bg-coral mr-2"></div>
            <span class="text-spanish-gray text-sm sm:text-base">Occupied</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    input, select {
        @apply w-full border border-spanish-gray/20 rounded px-3 py-2 focus:outline-none focus:border-sea text-sm sm:text-base;
    }
    .errorlist {
        @apply text-coral text-xs sm:text-sm mt-1;
    }
    .space-block.selected {
        @apply ring-4 ring-dark-puce scale-105 shadow-lg;
    }
    #selectedSpaceInfo.show {
        @apply scale-100 opacity-100;
    }
    #selectedSpaceInfo {
        @apply scale-95 opacity-0;
    }
    @media (max-width: 640px) {
        .space-block {
            @apply text-sm;
        }
        input[type="datetime-local"] {
            @apply text-sm;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function selectSpace(spaceId, spaceNumber, side) {
        // Remove previous selection
        document.querySelectorAll('.space-block').forEach(block => {
            block.classList.remove('selected');
        });
        
        // Add selection to clicked space
        const clickedSpace = document.querySelector(`[data-space-id="${spaceId}"] .space-block`);
        if (clickedSpace) {
            clickedSpace.classList.add('selected');
        }

        // Update selected space info
        const spaceDetails = document.getElementById('spaceDetails');
        const spaceInfo = document.getElementById('selectedSpaceInfo');
        
        if (spaceDetails && spaceInfo) {
            spaceDetails.textContent = `Space ${spaceNumber}, Side ${side} in ${document.querySelector('h1').textContent}`;
            spaceInfo.classList.remove('hidden');
            // Add show class after a brief delay to trigger animation
            setTimeout(() => {
                spaceInfo.classList.add('show');
            }, 10);
        }

        // Find the parking space select element
        const spaceSelect = document.querySelector('select[name="parking_space"]');
        if (spaceSelect) {
            // Set the selected value
            spaceSelect.value = spaceId;
            
            // Scroll to the booking form with offset for the fixed header (if any)
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                const headerOffset = 80; // Adjust this value based on your header height
                const elementPosition = bookingForm.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Focus on the start time input
                const startTimeInput = document.querySelector('input[name="start_time"]');
                if (startTimeInput) {
                    startTimeInput.focus();
                }
            }
        }
    }

    // Initialize selection if a space is already selected
    document.addEventListener('DOMContentLoaded', function() {
        const spaceSelect = document.querySelector('select[name="parking_space"]');
        if (spaceSelect && spaceSelect.value) {
            const option = spaceSelect.options[spaceSelect.selectedIndex];
            const match = option.text.match(/Space (\d+), Side ([A-D])/);
            if (match) {
                selectSpace(spaceSelect.value, match[1], match[2]);
            }
        }
    });
</script>
{% endblock %} 